<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetBuddy</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* style.css */

        /* Color Variables for easy theme switching */
        :root {
            --primary-color: #4CAF50; /* A fresh green */
            --secondary-color: #81C784; /* Lighter green */
            --accent-color: #FFD54F; /* A warm yellow accent */
            --background-light: #e8f5e9; /* Light green background */
            --card-background-light: #ffffff; /* White card background */
            --text-color-light: #333333; /* Dark gray text */
            --border-color-light: #c8e6c9; /* Light green border */
            --danger-color: #ef4444; /* Red for delete/danger */
            --success-color: #22c55e; /* Green for success */
            --warning-color: #f59e0b; /* Orange for warnings */

            /* Dark Mode Variables */
            --background-dark: #000000; /* Full black background */
            --card-background-dark: #000000; /* Full black card background */
            --text-color-dark: #e0e0e0;
            --border-color-dark: #546E7A;
        }

        /* Dark Mode specific styles */
        body.dark-mode {
            --background-light: var(--background-dark);
            --card-background-light: var(--card-background-dark);
            --text-color-light: var(--text-color-dark);
            --border-color-light: var(--border-color-dark);
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            color: var(--text-color-light);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background-color: var(--card-background-light);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .logo {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin-right: 1rem; /* Space between logo and nav on desktop */
        }

        .nav ul {
            list-style: none;
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color-light);
            font-weight: 500;
            padding: 0.5rem 0;
            position: relative;
            transition: color 0.3s ease;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        .nav-link.active {
            color: var(--primary-color);
        }

        /* Dark Mode Toggle Button in Header */
        .dark-mode-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color-light);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            padding: 0.5rem;
            border-radius: 50%;
        }

        .dark-mode-toggle:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        /* Sections */
        .section {
            display: none; /* Hidden by default, JavaScript will show/hide */
            padding: 2rem 0;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background-color: var(--card-background-light);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .card h2, .card h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color-light);
            padding-bottom: 0.5rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr; /* Single column on mobile */
            gap: 1.5rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-light);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--text-color-light);
            background-color: var(--background-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none;
            gap: 0.5rem;
        }

        .btn i {
            font-size: 1.1rem;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.2);
        }

        .primary-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .secondary-btn {
            background-color: var(--background-light);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .secondary-btn:hover {
            background-color: var(--primary-color);
            color: #ffffff;
            transform: translateY(-2px);
        }

        .danger-btn {
            background-color: var(--danger-color);
            color: #ffffff;
        }

        .danger-btn:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        /* Summary Section */
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem 0;
            border-bottom: 1px dashed var(--border-color-light);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .amount-display {
            font-weight: 600;
            color: var(--primary-color);
        }

        .category-breakdown div {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.95rem;
            border-bottom: 1px dotted var(--border-color-light);
        }

        .category-breakdown div:last-child {
            border-bottom: none;
        }

        .category-breakdown span:first-child {
            font-weight: 500;
        }

        /* Chart */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for chart on smaller screens */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #spending-chart {
            max-height: 100%;
            max-width: 100%;
        }

        .chart-message {
            position: absolute;
            text-align: center;
            color: var(--text-color-light);
            font-style: italic;
            opacity: 0.7;
        }

        /* Expense Table */
        .expense-table-container {
            overflow-x: auto; /* Allows horizontal scroll on small screens */
            margin-top: 1.5rem;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .expense-table th,
        .expense-table td {
            text-align: left;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-color-light);
        }

        .expense-table th {
            background-color: var(--background-light);
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .expense-table tbody tr:hover {
            background-color: rgba(76, 175, 80, 0.05);
        }

        .expense-table .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.1rem;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .expense-table .delete-btn:hover {
            color: #dc2626;
            transform: scale(1.1);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-end;
        }

        .filter-controls .form-group {
            margin-bottom: 0; /* Override default form-group margin */
            flex: 1; /* Allow items to grow */
            min-width: 150px; /* Minimum width for filter inputs */
        }

        .date-range-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .date-range-filter input[type="date"] {
            flex-grow: 1;
            min-width: 120px;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Settings Switch (Dark Mode Toggle) */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color-light);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .settings-card .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed var(--border-color-light);
        }

        .settings-card .setting-item:last-child {
            border-bottom: none;
        }

        /* Message Box for alerts */
        .message-box {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            text-align: center;
            font-weight: 500;
            opacity: 0; /* Hidden by default */
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message-box.success {
            background-color: rgba(34, 197, 94, 0.1); /* green-100 */
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .message-box.error {
            background-color: rgba(239, 68, 68, 0.1); /* red-100 */
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .message-box.warning {
            background-color: rgba(245, 158, 11, 0.1); /* orange-100 */
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .warning-text {
            color: var(--warning-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .no-data-message {
            text-align: center;
            color: var(--text-color-light);
            opacity: 0.6;
            font-style: italic;
            padding: 1rem 0;
        }

        /* Animations (using a simple custom keyframe approach) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate__fadeInUp {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate__popIn {
            animation: popIn 0.4s ease-out forwards;
        }

        /* Media Queries for Responsiveness */

        /* Tablet and larger screens */
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr; /* Two columns */
            }

            .add-expense-card {
                grid-column: span 1;
            }

            .summary-card {
                grid-column: span 1;
            }

            .chart-card {
                grid-column: span 2; /* Chart takes full width below */
            }

            .filter-controls {
                justify-content: flex-start;
            }

            .date-range-filter {
                flex-wrap: nowrap;
            }
        }

        /* Desktop and larger screens */
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1.5fr 1fr 1.5fr; /* More flexible layout */
                grid-template-areas:
                    "add-expense summary chart"
                    "add-expense summary chart"; /* Example layout */
            }

            .add-expense-card {
                grid-area: add-expense;
            }

            .summary-card {
                grid-area: summary;
            }

            .chart-card {
                grid-area: chart;
                height: auto; /* Allow chart card to adjust height */
            }

            .header .container {
                flex-wrap: nowrap;
            }
        }

        /* Adjust chart height for larger screens */
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }

        /* Small adjustments for very small screens */
        @media (max-width: 480px) {
            .header .container {
                flex-direction: column;
                gap: 1rem;
            }
            .nav ul {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }
            .logo {
                margin-bottom: 0.5rem;
            }
            .btn {
                width: 100%;
                margin-top: 0.5rem;
            }
            .export-options {
                flex-direction: column;
            }
            .filter-controls .form-group {
                width: 100%;
            }
            .date-range-filter {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">BudgetBuddy</h1>
            <nav class="nav">
                <ul>
                    <li><a href="#dashboard" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                    <li><a href="#expense-history" class="nav-link" data-section="expense-history">History</a></li>
                    <li><a href="#settings" class="nav-link" data-section="settings">Settings</a></li>
                </ul>
            </nav>
            <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="container">
        <section id="dashboard" class="section active">
            <div class="dashboard-grid">
                <div class="card add-expense-card animate__animated animate__fadeInUp">
                    <h2>Add New Expense</h2>
                    <form id="add-expense-form">
                        <div class="form-group">
                            <label for="expense-title">Title</label>
                            <input type="text" id="expense-title" placeholder="e.g., Groceries, Internet Bill" required>
                        </div>
                        <div class="form-group">
                            <label for="expense-amount">Amount</label>
                            <input type="number" id="expense-amount" placeholder="e.g., 50.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="expense-category">Category</label>
                            <select id="expense-category" required>
                                <option value="">Select Category</option>
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Housing">Housing</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-date">Date</label>
                            <input type="date" id="expense-date" required>
                        </div>
                        <button type="submit" class="btn primary-btn"><i class="fas fa-plus-circle"></i> Add Expense</button>
                    </form>
                    <div class="form-group budget-goal-section">
                        <label for="budget-goal">Monthly Budget Goal (₹)</label>
                        <input type="number" id="budget-goal" placeholder="e.g., 1000">
                        <p id="budget-warning" class="warning-text"></p>
                    </div>
                </div>

                <div class="card summary-card animate__animated animate__fadeInUp">
                    <h2>Spending Summary</h2>
                    <div class="summary-item">
                        <span>Total Expenses:</span>
                        <span id="total-expenses" class="amount-display">₹0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>Today's Expenses:</span>
                        <span id="daily-expenses" class="amount-display">₹0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>This Week's Expenses:</span>
                        <span id="weekly-expenses" class="amount-display">₹0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>This Month's Expenses:</span>
                        <span id="monthly-expenses" class="amount-display">₹0.00</span>
                    </div>
                    <h3>Category Breakdown</h3>
                    <div id="category-breakdown" class="category-breakdown">
                        <p class="no-data-message">No expenses yet. Add some to see your breakdown!</p>
                    </div>
                </div>

                <div class="card chart-card animate__animated animate__fadeInUp">
                    <h2>Spending Chart</h2>
                    <div class="chart-container">
                        <canvas id="spending-chart"></canvas>
                        <p id="chart-no-data" class="no-data-message chart-message">Add expenses to see your spending chart!</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="expense-history" class="section">
            <div class="card animate__animated animate__fadeInUp">
                <h2>Expense History</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="filter-category">Filter by Category:</label>
                        <select id="filter-category">
                            <option value="all">All Categories</option>
                            <option value="Food">Food</option>
                            <option value="Transport">Transport</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Housing">Housing</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Education">Education</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group date-range-filter">
                        <label for="start-date">From:</label>
                        <input type="date" id="start-date">
                        <label for="end-date">To:</label>
                        <input type="date" id="end-date">
                        <button id="apply-date-filter" class="btn secondary-btn">Apply Filter</button>
                    </div>
                </div>
                <div class="expense-table-container">
                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list">
                            <tr><td colspan="5" class="no-data-message">No expenses recorded yet.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="export-options">
                    <button id="export-csv" class="btn secondary-btn"><i class="fas fa-file-csv"></i> Export CSV</button>
                    <button id="export-json" class="btn secondary-btn"><i class="fas fa-file-code"></i> Export JSON</button>
                </div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="card settings-card animate__animated animate__fadeInUp">
                <h2>Settings</h2>
                <div class="setting-item">
                    <span>Dark Mode:</span>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle-settings">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <button id="reset-data" class="btn danger-btn"><i class="fas fa-redo-alt"></i> Reset All Data</button>
                </div>
                <div id="message-box" class="message-box"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025. </p>
            <p>Created by RSMK.</p>
            <p>for Everybody</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // script.js

        // --- DOM Elements ---
        const addExpenseForm = document.getElementById('add-expense-form');
        const expenseTitleInput = document.getElementById('expense-title');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseCategorySelect = document.getElementById('expense-category');
        const expenseDateInput = document.getElementById('expense-date');
        const expenseListBody = document.getElementById('expense-list');
        const totalExpensesSpan = document.getElementById('total-expenses');
        const dailyExpensesSpan = document.getElementById('daily-expenses');
        const weeklyExpensesSpan = document.getElementById('weekly-expenses');
        const monthlyExpensesSpan = document.getElementById('monthly-expenses');
        const categoryBreakdownDiv = document.getElementById('category-breakdown');
        const spendingChartCanvas = document.getElementById('spending-chart');
        const chartNoDataMessage = document.getElementById('chart-no-data');
        const filterCategorySelect = document.getElementById('filter-category');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        const exportCsvBtn = document.getElementById('export-csv');
        const exportJsonBtn = document.getElementById('export-json');
        const darkModeToggleHeader = document.getElementById('dark-mode-toggle');
        const darkModeToggleSettings = document.getElementById('dark-mode-toggle-settings');
        const resetDataBtn = document.getElementById('reset-data');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const budgetGoalInput = document.getElementById('budget-goal');
        const budgetWarningText = document.getElementById('budget-warning');
        const messageBox = document.getElementById('message-box');

        // --- Global Variables ---
        let expenses = [];
        let spendingChart; // To hold the Chart.js instance
        const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Shopping", "Housing", "Healthcare", "Education", "Other"];

        // --- Utility Functions ---

        /**
         * Displays a temporary message box to the user.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'warning').
         */
        function showMessageBox(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`; // Apply classes for styling
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The amount to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(amount) {
            return `₹${amount.toFixed(2)}`;
        }

        /**
         * Generates a unique ID for an expense.
         * @returns {string} - A unique ID.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // --- LocalStorage Functions ---

        /**
         * Loads expenses from LocalStorage.
         */
        function loadExpenses() {
            try {
                const storedExpenses = localStorage.getItem('budgetBuddyExpenses');
                expenses = storedExpenses ? JSON.parse(storedExpenses) : [];
                // Ensure amounts are numbers
                expenses.forEach(exp => exp.amount = parseFloat(exp.amount));
            } catch (e) {
                console.error("Error loading expenses from LocalStorage:", e);
                expenses = [];
                showMessageBox("Error loading data. Your data might be corrupted.", "error");
            }
        }

        /**
         * Saves expenses to LocalStorage.
         */
        function saveExpenses() {
            try {
                localStorage.setItem('budgetBuddyExpenses', JSON.stringify(expenses));
            } catch (e) {
                console.error("Error saving expenses to LocalStorage:", e);
                showMessageBox("Error saving data. Please check your browser storage.", "error");
            }
        }

        /**
         * Loads the budget goal from LocalStorage.
         */
        function loadBudgetGoal() {
            try {
                const storedGoal = localStorage.getItem('budgetBuddyGoal');
                if (storedGoal) {
                    budgetGoalInput.value = storedGoal;
                }
            } catch (e) {
                console.error("Error loading budget goal:", e);
            }
        }

        /**
         * Saves the budget goal to LocalStorage.
         */
        function saveBudgetGoal() {
            try {
                localStorage.setItem('budgetBuddyGoal', budgetGoalInput.value);
            } catch (e) {
                console.error("Error saving budget goal:", e);
            }
        }

        /**
         * Loads dark mode preference from LocalStorage.
         */
        function loadDarkModePreference() {
            try {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    darkModeToggleHeader.querySelector('i').classList.replace('fa-moon', 'fa-sun');
                    darkModeToggleSettings.checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    darkModeToggleHeader.querySelector('i').classList.replace('fa-sun', 'fa-moon');
                    darkModeToggleSettings.checked = false;
                }
            } catch (e) {
                console.error("Error loading dark mode preference:", e);
            }
        }

        /**
         * Saves dark mode preference to LocalStorage.
         * @param {boolean} isDarkMode - True if dark mode is enabled, false otherwise.
         */
        function saveDarkModePreference(isDarkMode) {
            try {
                localStorage.setItem('darkMode', isDarkMode);
            } catch (e) {
                console.error("Error saving dark mode preference:", e);
            }
        }

        // --- Expense Management Functions ---

        /**
         * Adds a new expense.
         * @param {Event} event - The form submission event.
         */
        function addExpense(event) {
            event.preventDefault();

            const title = expenseTitleInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const category = expenseCategorySelect.value;
            const date = expenseDateInput.value; // YYYY-MM-DD format

            if (!title || isNaN(amount) || amount <= 0 || !category || !date) {
                showMessageBox("Please fill in all fields correctly.", "error");
                return;
            }

            const newExpense = {
                id: generateUniqueId(),
                title,
                amount,
                category,
                date
            };

            expenses.push(newExpense);
            saveExpenses();
            renderExpenses();
            checkBudget();
            showMessageBox("Expense added successfully!", "success");

            // Clear form
            addExpenseForm.reset();
            expenseDateInput.valueAsDate = new Date(); // Reset date to today
        }

        /**
         * Deletes an expense by its ID.
         * @param {string} id - The ID of the expense to delete.
         */
        function deleteExpense(id) {
            const confirmDelete = confirm("Are you sure you want to delete this expense?");
            if (!confirmDelete) {
                return;
            }

            expenses = expenses.filter(expense => expense.id !== id);
            saveExpenses();
            renderExpenses();
            checkBudget();
            showMessageBox("Expense deleted.", "warning");
        }

        /**
         * Renders the expenses in the table and updates all summary sections and chart.
         */
        function renderExpenses() {
            const filterCategory = filterCategorySelect.value;
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            // Filter expenses based on criteria
            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const matchesCategory = filterCategory === 'all' || expense.category === filterCategory;
                const matchesStartDate = !startDate || expenseDate >= startDate;
                const matchesEndDate = !endDate || expenseDate <= endDate;
                return matchesCategory && matchesStartDate && matchesEndDate;
            });

            expenseListBody.innerHTML = ''; // Clear existing rows

            if (filteredExpenses.length === 0) {
                expenseListBody.innerHTML = '<tr><td colspan="5" class="no-data-message">No expenses found for the selected filters.</td></tr>';
            } else {
                filteredExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.classList.add('animate__popIn'); // Add animation class
                    row.innerHTML = `
                        <td>${expense.title}</td>
                        <td>${expense.category}</td>
                        <td>${formatCurrency(expense.amount)}</td>
                        <td>${expense.date}</td>
                        <td>
                            <button class="delete-btn" data-id="${expense.id}" aria-label="Delete expense">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    expenseListBody.appendChild(row);
                });
            }

            // Attach event listeners to new delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteExpense(e.currentTarget.dataset.id);
            });

            updateSummary(expenses); // Always use all expenses for summary
            updateChart(expenses); // And for the chart
        }

        /**
         * Updates the spending summary section.
         * @param {Array} currentExpenses - The array of expenses to base the summary on.
         */
        function updateSummary(currentExpenses) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday as start of week
            startOfWeek.setHours(0, 0, 0, 0);

            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            let total = 0;
            let daily = 0;
            let weekly = 0;
            let monthly = 0;
            const categoryTotals = {};

            expenses.forEach(expense => { // Use 'expenses' (all data) for summary, not filtered
                const expenseDate = new Date(expense.date);
                expenseDate.setHours(0, 0, 0, 0);

                total += expense.amount;

                if (expenseDate.getTime() === today.getTime()) {
                    daily += expense.amount;
                }
                if (expenseDate >= startOfWeek) {
                    weekly += expense.amount;
                }
                if (expenseDate >= startOfMonth) {
                    monthly += expense.amount;
                }

                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            totalExpensesSpan.textContent = formatCurrency(total);
            dailyExpensesSpan.textContent = formatCurrency(daily);
            weeklyExpensesSpan.textContent = formatCurrency(weekly);
            monthlyExpensesSpan.textContent = formatCurrency(monthly);

            // Update Category Breakdown
            categoryBreakdownDiv.innerHTML = '';
            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

            if (sortedCategories.length === 0) {
                categoryBreakdownDiv.innerHTML = '<p class="no-data-message">No expenses yet. Add some to see your breakdown!</p>';
            } else {
                sortedCategories.forEach(([category, amount]) => {
                    const div = document.createElement('div');
                    div.innerHTML = `<span>${category}:</span> <span>${formatCurrency(amount)}</span>`;
                    categoryBreakdownDiv.appendChild(div);
                });
            }
        }

        // --- Chart Functions (Chart.js) ---

        /**
         * Initializes the Chart.js instance.
         */
        function initChart() {
            const ctx = spendingChartCanvas.getContext('2d');
            spendingChart = new Chart(ctx, {
                type: 'pie', // Default to pie chart
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#4CAF50', '#81C784', '#FFD54F', '#64B5F6', '#9575CD',
                            '#FF8A65', '#A1887F', '#E0E0E0', '#795548', '#B0BEC5'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color-light'),
                                font: {
                                    family: 'Poppins'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        /**
         * Updates the Chart.js data based on current expenses.
         * @param {Array} currentExpenses - The array of expenses to update the chart with.
         */
        function updateChart(currentExpenses) {
            const categoryTotals = {};
            currentExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            if (labels.length === 0) {
                spendingChartCanvas.style.display = 'none';
                chartNoDataMessage.style.display = 'block';
            } else {
                spendingChartCanvas.style.display = 'block';
                chartNoDataMessage.style.display = 'none';
            }

            spendingChart.data.labels = labels;
            spendingChart.data.datasets[0].data = data;
            spendingChart.update();
        }

        // --- Filtering Functions ---

        /**
         * Applies filters and re-renders expenses.
         */
        function applyFilters() {
            renderExpenses(); // renderExpenses already handles filtering
        }

        // --- Export Functions ---

        /**
         * Exports expenses data as a CSV file.
         */
        function exportCSV() {
            if (expenses.length === 0) {
                showMessageBox("No data to export.", "warning");
                return;
            }

            let csvContent = "Title,Category,Amount,Date\n";
            expenses.forEach(expense => {
                csvContent += `${expense.title},${expense.category},${expense.amount},${expense.date}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'budgetbuddy_expenses.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox("Expenses exported as CSV!", "success");
        }

        /**
         * Exports expenses data as a JSON file.
         */
        function exportJSON() {
            if (expenses.length === 0) {
                showMessageBox("No data to export.", "warning");
                return;
            }

            const jsonContent = JSON.stringify(expenses, null, 2); // Pretty print JSON
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'budgetbuddy_expenses.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox("Expenses exported as JSON!", "success");
        }

        // --- Dark Mode Toggle ---

        /**
         * Toggles dark mode on/off.
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            saveDarkModePreference(isDarkMode);

            // Update icon in header
            const icon = darkModeToggleHeader.querySelector('i');
            if (isDarkMode) {
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                icon.classList.replace('fa-sun', 'fa-moon');
            }

            // Sync settings toggle
            darkModeToggleSettings.checked = isDarkMode;

            // Update chart text color for dark mode
            if (spendingChart) {
                spendingChart.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-color-light');
                spendingChart.update();
            }
        }

        // --- Budget Goal Functions ---

        /**
         * Checks if the current monthly spending exceeds the budget goal and displays a warning.
         */
        function checkBudget() {
            const budgetGoal = parseFloat(budgetGoalInput.value);
            if (isNaN(budgetGoal) || budgetGoal <= 0) {
                budgetWarningText.textContent = '';
                return;
            }

            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            let currentMonthlySpending = 0;
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                expenseDate.setHours(0, 0, 0, 0);
                if (expenseDate >= startOfMonth) {
                    currentMonthlySpending += expense.amount;
                }
            });

            if (currentMonthlySpending > budgetGoal) {
                budgetWarningText.textContent = `Warning: You are ${formatCurrency(currentMonthlySpending - budgetGoal)} over your monthly budget goal of ${formatCurrency(budgetGoal)}!`;
                budgetWarningText.classList.add('warning-text');
            } else {
                budgetWarningText.textContent = `You have ${formatCurrency(budgetGoal - currentMonthlySpending)} remaining in your monthly budget.`;
                budgetWarningText.classList.remove('warning-text');
            }
        }

        // --- Reset Data Function ---

        /**
         * Resets all stored data in LocalStorage.
         */
        function resetAllData() {
            const confirmReset = confirm("Are you sure you want to reset ALL your data? This action cannot be undone.");
            if (!confirmReset) {
                return;
            }

            localStorage.clear();
            expenses = [];
            budgetGoalInput.value = '';
            budgetWarningText.textContent = '';
            renderExpenses();
            showMessageBox("All data has been reset.", "warning");
        }

        // --- Navigation and Section Switching ---

        /**
         * Handles navigation clicks to show/hide sections.
         * @param {Event} event - The click event.
         */
        function handleNavigation(event) {
            event.preventDefault();
            const targetSectionId = event.currentTarget.dataset.section;

            // Remove active class from all nav links and sections
            navLinks.forEach(link => link.classList.remove('active'));
            sections.forEach(section => {
                section.classList.remove('active');
                section.classList.remove('animate__fadeInUp'); // Remove animation class
            });

            // Add active class to clicked nav link
            event.currentTarget.classList.add('active');

            // Show target section with animation
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.classList.add('animate__fadeInUp'); // Add animation class
            }
        }

        // --- Initialization ---

        /**
         * Initializes the application on page load.
         */
        function initApp() {
            loadDarkModePreference(); // Load dark mode first to apply theme
            loadExpenses();
            loadBudgetGoal();
            initChart(); // Initialize chart before rendering expenses
            renderExpenses(); // This will update summary and chart
            checkBudget();

            // Set default date to today
            expenseDateInput.valueAsDate = new Date();

            // --- Event Listeners ---
            addExpenseForm.addEventListener('submit', addExpense);
            filterCategorySelect.addEventListener('change', applyFilters);
            applyDateFilterBtn.addEventListener('click', applyFilters);
            exportCsvBtn.addEventListener('click', exportCSV);
            exportJsonBtn.addEventListener('click', exportJSON);
            darkModeToggleHeader.addEventListener('click', toggleDarkMode);
            darkModeToggleSettings.addEventListener('change', toggleDarkMode); // For settings page toggle
            resetDataBtn.addEventListener('click', resetAllData);
            budgetGoalInput.addEventListener('input', () => {
                saveBudgetGoal(); // Save goal on input change
                checkBudget(); // Re-check budget
            });

            navLinks.forEach(link => {
                link.addEventListener('click', handleNavigation);
            });

            // Ensure Dashboard is active on initial load
            document.getElementById('dashboard').classList.add('active');
            document.querySelector('.nav-link[data-section="dashboard"]').classList.add('active');
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered: ', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
